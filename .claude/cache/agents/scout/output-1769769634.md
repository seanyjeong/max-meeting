# Max-Meeting Codebase Analysis Report
Generated: 2026-01-30 10:35 UTC

## Summary

| Category | Count |
|----------|-------|
| **API Endpoints** | 58 total |
| **Backend Models** | 11 |
| **Backend Services** | 12 |
| **Frontend Routes** | 13 pages + 1 layout |
| **Frontend Components** | 43 |
| **Frontend Stores** | 12 (9 production + 3 test files) |

---

## Backend Analysis

### API Routers (11 files)

#### 1. **auth.py** - Authentication (4 endpoints)
- `POST /login` - User login with email/password
- `POST /refresh` - Refresh JWT token
- `POST /logout` - User logout
- `GET /me` - Get current user info

#### 2. **contacts.py** - Contact Management (5 endpoints)
- `GET /contacts` - List all contacts
- `GET /contacts/{contact_id}` - Get specific contact
- `POST /contacts` - Create new contact
- `PATCH /contacts/{contact_id}` - Update contact
- `DELETE /contacts/{contact_id}` - Delete contact

#### 3. **meetings.py** - Meeting Management (8 endpoints)
- `GET /meetings` - List meetings with filters (status, pagination)
- `GET /meetings/{meeting_id}` - Get meeting details with attendees/agendas
- `POST /meetings` - Create new meeting
- `PATCH /meetings/{meeting_id}` - Update meeting
- `DELETE /meetings/{meeting_id}` - Soft delete meeting
- `POST /meetings/{meeting_id}/restore` - Restore deleted meeting
- `POST /meetings/{meeting_id}/attendees` - Add attendee
- `DELETE /meetings/{meeting_id}/attendees/{contact_id}` - Remove attendee

#### 4. **agendas.py** - Agenda Management (12 endpoints)
- `GET /meetings/{meeting_id}/agendas` - List agendas for meeting
- `POST /meetings/{meeting_id}/agendas` - Create agenda
- `POST /meetings/{meeting_id}/agendas/parse` - Parse text to create hierarchical agendas (LLM)
- `POST /meetings/{meeting_id}/agendas/parse/preview` - Preview parsed agendas without saving
- `GET /agendas/{agenda_id}` - Get specific agenda
- `PATCH /agendas/{agenda_id}` - Update agenda
- `DELETE /agendas/{agenda_id}` - Delete agenda (soft delete)
- `POST /agendas/{agenda_id}/reorder` - Reorder agendas (drag-drop)
- `POST /agendas/{agenda_id}/move` - Move agenda to new parent/position
- `POST /agendas/{agenda_id}/questions` - Add question to agenda
- `PATCH /questions/{question_id}` - Update question
- `DELETE /questions/{question_id}` - Delete question

#### 5. **recordings.py** - Recording & STT (9 endpoints)
- `GET /meetings/{meeting_id}/recordings` - List recordings for meeting (NEW)
- `POST /meetings/{meeting_id}/recordings` - Create recording entry
- `GET /recordings/{recording_id}` - Get recording with transcript
- `PATCH /recordings/{recording_id}` - Update recording status
- `DELETE /recordings/{recording_id}` - Delete recording and file
- `POST /recordings/{recording_id}/process` - Manual STT trigger (NEW)
- `POST /recordings/{recording_id}/upload` - Upload recording chunk
- `HEAD /recordings/{recording_id}/upload` - Get upload status
- `GET /recordings/{recording_id}/progress` - SSE endpoint for STT progress

#### 6. **results.py** - Meeting Results (10 endpoints)
- `GET /meetings/{meeting_id}/results` - List result versions
- `POST /meetings/{meeting_id}/results` - Create result (manual or LLM)
- `GET /results/{result_id}` - Get result with decisions/action items
- `PATCH /results/{result_id}` - Update result (summary, key_points)
- `POST /results/{result_id}/verify` - Mark result as verified
- `POST /results/{result_id}/regenerate` - Trigger LLM regeneration
- `GET /meetings/{meeting_id}/action-items` - List action items
- `POST /results/{result_id}/action-items` - Add action item
- `PATCH /action-items/{action_item_id}` - Update action item
- `DELETE /action-items/{action_item_id}` - Delete action item

#### 7. **notes.py** - Meeting Notes (5 endpoints)
- `GET /meetings/{meeting_id}/notes` - List notes for meeting
- `POST /meetings/{meeting_id}/notes` - Create note
- `GET /notes/{note_id}` - Get specific note
- `PATCH /notes/{note_id}` - Update note
- `DELETE /notes/{note_id}` - Delete note

#### 8. **sketches.py** - Sketch Export (1 endpoint)
- `GET /sketches/{sketch_id}/export` - Export sketch as PNG

#### 9. **search.py** - Full-text Search (1 endpoint)
- `GET /search` - Search across meetings/contacts/notes

#### 10. **meeting_types.py** - Meeting Type Templates (3 endpoints)
- `GET /meeting-types` - List meeting types
- `POST /meeting-types` - Create meeting type
- `DELETE /meeting-types/{type_id}` - Delete meeting type

---

### Backend Models (11 files)

| Model | Purpose |
|-------|---------|
| `agenda.py` | Agenda, AgendaQuestion - hierarchical agenda with parent/children |
| `audit.py` | AuditLog - track system changes |
| `base.py` | Base, TimestampMixin, SoftDeleteMixin - common model functionality |
| `contact.py` | Contact - encrypted PII storage (name, email, phone) |
| `enums.py` | MeetingStatus, RecordingStatus, AgendaStatus, etc. |
| `meeting.py` | Meeting, MeetingAttendee, MeetingType - core meeting entity |
| `note.py` | Note - meeting notes |
| `recording.py` | Recording, Transcript, TranscriptSegment - audio + STT data |
| `result.py` | Result, Decision, ActionItem - LLM-generated meeting summary |
| `task.py` | Task, TaskTracking - async task management |

---

### Backend Services (12 files)

| Service | Purpose |
|---------|---------|
| `agenda.py` | Agenda CRUD, LLM parsing for hierarchical agendas |
| `contact.py` | Contact CRUD with PII encryption (Fernet) |
| `encryption.py` | Fernet encryption for PII fields |
| `gemini.py` | Google Gemini API client (agenda parsing, summarization) |
| `llm.py` | LLM orchestration - generate results from transcript/notes |
| `meeting.py` | Meeting CRUD, attendee management |
| `recording.py` | Recording upload (chunked), file management |
| `result.py` | Result versioning, action items, decisions |
| `search.py` | Full-text search across entities |
| `speaker_analytics.py` | Speaker identification and analytics from STT |
| `stt.py` | Speech-to-text pipeline (faster-whisper + pyannote diarization) |

---

## Frontend Analysis

### Routes (13 pages + 1 layout)

| Route | Purpose |
|-------|---------|
| `/` | Dashboard/home page |
| `/login` | Authentication |
| `/contacts` | Contact list |
| `/contacts/new` | Create contact |
| `/contacts/[id]` | Contact detail/edit |
| `/meetings` | Meeting list |
| `/meetings/new` | Create meeting |
| `/meetings/[id]` | Meeting detail |
| `/meetings/[id]/sketch` | Sketch/whiteboard (tldraw) |
| `/meetings/[id]/record` | Audio recording interface |
| `/meetings/[id]/results` | Meeting results/summary view |
| `/meetings/[id]/results/edit` | Edit meeting results |
| `/meetings/deleted` | Soft-deleted meetings |
| `+layout.svelte` | Root layout (nav, auth guard) |

---

### Components (43 files, organized by category)

#### Core UI (9 components)
- `Button.svelte` - Button component
- `Input.svelte` - Form input
- `Modal.svelte` - Modal dialog
- `Toast.svelte` - Toast notification
- `ToastContainer.svelte` - Toast container
- `LoadingSpinner.svelte` - Loading indicator
- `Breadcrumb.svelte` - Breadcrumb navigation
- `DarkModeToggle.svelte` - Theme switcher
- `AgendaEditor.svelte` - Agenda text editor

#### UI Components (`ui/` - 9 components)
- `ConfirmDialog.svelte` - Confirmation modal
- `EmptyState.svelte` - Empty state placeholder
- `ErrorBoundary.svelte` - Error boundary wrapper
- `KeyboardShortcuts.svelte` - Keyboard shortcut display
- `MeetingCard.svelte` - Meeting card in list
- `OfflineIndicator.svelte` - Offline mode indicator
- `RecordingStatus.svelte` - Recording status badge
- `Skeleton.svelte` - Skeleton loader
- `Tabs.svelte` - Tab navigation
- `ToastV2.svelte` - Toast v2
- `ToastContainerV2.svelte` - Toast container v2

#### Results Components (`results/` - 4 components)
- `ActionItems.svelte` - Action item list/editor
- `SpeakerMapper.svelte` - Map transcript speakers to contacts
- `SummaryEditor.svelte` - Edit meeting summary
- `TranscriptViewer.svelte` - View transcript with timeline

#### Sketch Components (`sketch/` - 3 components)
- `SketchPad.svelte` - Sketch canvas wrapper
- `SketchToolbar.svelte` - Drawing toolbar
- `TldrawWrapper.svelte` - Tldraw integration

#### Recording Components (`recording/` - directory exists, files not detailed)

#### Layout Components (`layout/` - 1 component)
- `Sidebar.svelte` - Navigation sidebar

#### System Components (5 components)
- `PreflightCheck.svelte` - System readiness check
- `SyncConflictDialog.svelte` - Offline sync conflict resolution
- `UpdateNotifier.svelte` - App update notification

---

### Stores (12 files - 9 production + 3 tests)

#### Production Stores (9)
| Store | Purpose |
|-------|---------|
| `auth.ts` | User authentication state, JWT tokens |
| `contacts.ts` | Contact list state |
| `meeting.ts` | Meeting state, attendees, agendas |
| `notes.ts` | Meeting notes state |
| `offline.ts` | Offline mode detection |
| `offlineCache.ts` | Offline data cache (IndexedDB) |
| `recording.ts` | Recording state, upload progress |
| `results.ts` | Meeting results state, regeneration |
| `sketch.ts` | Sketch/drawing state (tldraw) |
| `toast.ts` | Toast notification queue |
| `viewport.ts` | Viewport/responsive state |

#### Test Files (3)
- `auth.test.ts`
- `meeting.test.ts`
- `results.test.ts`
- `sketch.test.ts`

---

## Key Recent Changes (Jan 28-30, 2026)

### 1. **STT Pipeline Overhaul** (commit 8743106)
**Files changed:**
- `backend/workers/tasks/stt.py` - Changed from Celery chord to sequential processing
- `backend/app/services/llm.py` - Added support for generating results without recording
- `frontend/src/lib/stores/results.ts` - Added recording state tracking
- `frontend/src/routes/meetings/[id]/results/+page.svelte` - Added "Generate from Notes" button
- `frontend/src/lib/components/results/TranscriptViewer.svelte` - Improved Korean empty state

**Changes:**
- Celery chord → sequential processing (fixes temp file cleanup issues)
- WebM duration detection improved (ffmpeg fallback)
- LLM can now generate summaries from agendas/notes only (no recording required)
- Results page shows recording state (none/pending/processing/complete)

### 2. **SQLAlchemy Performance Fix** (commit 4eef11b)
**Files changed:**
- `backend/app/models/agenda.py` - Added `lazy="noload"` to relationships
- `backend/app/models/meeting.py` - Added `lazy="noload"` to relationships
- `backend/app/routers/recordings.py` - Added 2 new endpoints
- `backend/app/services/recording.py` - Added recording list service

**Changes:**
- All relationships now use `lazy="noload"` to prevent N+1 queries
- Performance: 15 seconds → 100ms for meeting detail API
- New API: `GET /meetings/{id}/recordings` - list recordings
- New API: `POST /recordings/{id}/process` - manual STT trigger
- Fixed TaskTracking meeting_id null error
- Fixed regenerate API missing request body

### 3. **PWA Support** (commit 9bb09d7)
**Changes:**
- Added service worker for offline support
- Version management system (v1.2.0)
- Update notification UI

### 4. **Terminology Change** (commit 2c24a4e)
**Changes:**
- "전사록" (transcript) → "대화 내용" (conversation content) throughout UI

### 5. **API Optimization** (commit 7505205)
**Changes:**
- Parallelized independent API requests
- Removed duplicate API calls
- Improved page load performance

### 6. **UX/UI Improvements** (commits a01009d, 4eef11b)
**Changes:**
- Tablet-optimized design
- Results page UX improvements (recording status indicators)
- Hierarchical agenda numbering
- Skeleton loaders for better perceived performance

---

## Architecture Patterns

### Backend
```
FastAPI Router → Service Layer → Repository (Model) → PostgreSQL
                      ↓
                 Celery Worker (STT/LLM tasks)
                      ↓
                   Redis (queue/cache)
```

### Frontend
```
SvelteKit Route → Store (Svelte 5 state) → API Client → Backend
                       ↓
                  IndexedDB (offline cache)
```

### Key Technologies
- **Backend**: FastAPI, SQLAlchemy (async), Celery, faster-whisper, pyannote, Gemini
- **Frontend**: SvelteKit 2, Svelte 5 (runes), TailwindCSS, tldraw
- **Database**: PostgreSQL 16 + Redis 7
- **Deployment**: Vercel (frontend) + systemd (backend) + Caddy (reverse proxy)

---

## Notable Implementation Details

### 1. **Hierarchical Agendas**
- Agendas support parent-child relationships (self-referential)
- LLM parsing creates nested structure from plain text
- Drag-drop reordering with `/agendas/{id}/move` endpoint

### 2. **PII Encryption**
- Contact names, emails, phones encrypted at rest (Fernet)
- Encryption key stored in environment variable
- Transparent encryption/decryption in service layer

### 3. **Chunked Upload**
- Recordings uploaded in chunks (configurable size)
- `HEAD /recordings/{id}/upload` returns current byte offset
- Client resumes from last successful chunk

### 4. **STT Pipeline**
- 1. Upload audio → temp file
- 2. Convert to WAV (ffmpeg)
- 3. VAD detection (silero-vad)
- 4. Speaker diarization (pyannote)
- 5. Transcription (faster-whisper)
- 6. Merge segments by speaker
- 7. Store in database

### 5. **LLM Result Generation**
- Input: transcript segments OR agendas + notes
- Gemini Flash generates: summary, key_points, decisions, action_items
- Multiple result versions supported (editing history)
- Manual regeneration with custom prompts

### 6. **Soft Delete Pattern**
- All main entities use `SoftDeleteMixin`
- `deleted_at` timestamp instead of hard delete
- Restore endpoints available (`POST /meetings/{id}/restore`)

### 7. **Offline Support**
- Service worker caches static assets
- IndexedDB stores API responses
- Sync conflict resolution UI when reconnecting

---

## Open Questions / Areas to Document Further

1. Celery worker deployment (systemd service configuration)
2. Redis configuration (persistence settings)
3. faster-whisper model selection (tiny/base/small/medium/large)
4. pyannote authentication token setup
5. Caddy reverse proxy configuration details
6. Database migration workflow (Alembic?)
7. End-to-end test coverage (e2e/ directory exists)

---

## File Path References

### Backend Key Files
- `/home/et/max-ops/max-meeting/backend/app/routers/` - API endpoints
- `/home/et/max-ops/max-meeting/backend/app/services/` - Business logic
- `/home/et/max-ops/max-meeting/backend/app/models/` - SQLAlchemy models
- `/home/et/max-ops/max-meeting/backend/workers/tasks/` - Celery tasks

### Frontend Key Files
- `/home/et/max-ops/max-meeting/frontend/src/routes/` - SvelteKit pages
- `/home/et/max-ops/max-meeting/frontend/src/lib/components/` - Reusable components
- `/home/et/max-ops/max-meeting/frontend/src/lib/stores/` - State management

### Configuration
- `/home/et/max-ops/max-meeting/backend/.env` - Backend environment variables
- `/home/et/max-ops/max-meeting/frontend/.env` - Frontend environment variables
- `/home/et/max-ops/max-meeting/CLAUDE.md` - Project quick reference

