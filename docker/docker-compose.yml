version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: maxmeeting-db
    restart: unless-stopped
    user: "999:999"
    environment:
      POSTGRES_USER: maxmeeting
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: maxmeeting
    secrets:
      - db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U maxmeeting"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: maxmeeting-redis
    restart: unless-stopped
    user: "999:999"
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
    ports:
      - "127.0.0.1:6379:6379"
    networks:
      - backend
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
    container_name: maxmeeting-app
    restart: unless-stopped
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    secrets:
      - jwt_secret
      - gemini_api_key
    environment:
      - DATABASE_URL=postgresql://maxmeeting:${DB_PASSWORD}@postgres:5432/maxmeeting
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
      - AUTH_PASSWORD_HASH=${AUTH_PASSWORD_HASH}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_EXPIRE_MINUTES=60
      - JWT_REFRESH_EXPIRE_DAYS=7
      - CORS_ORIGINS=["https://meeting.etlab.kr","http://localhost:5173"]
      - ALLOWED_HOSTS=["meeting.etlab.kr","localhost"]
    ports:
      - "127.0.0.1:8000:8000"  # localhost만 바인딩
    volumes:
      - type: bind
        source: ${STORAGE_PATH}
        target: /data/max-meeting
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend
      - frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    container_name: maxmeeting-worker
    restart: unless-stopped
    user: "1000:1000"
    secrets:
      - gemini_api_key
      - huggingface_token
    environment:
      - DATABASE_URL=postgresql://maxmeeting:${DB_PASSWORD}@postgres:5432/maxmeeting
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_TASK_ACKS_LATE=true
      - HUGGINGFACE_TOKEN_FILE=/run/secrets/huggingface_token
    volumes:
      - type: bind
        source: ${STORAGE_PATH}
        target: /data/max-meeting
    depends_on:
      - redis
      - postgres
    networks:
      - backend
    deploy:
      resources:
        limits:
          memory: 12G
        reservations:
          memory: 8G

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: maxmeeting-frontend
    restart: unless-stopped
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://app:8000
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      - app
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  backend:
    internal: true  # 외부 접근 차단
  frontend:

secrets:
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  gemini_api_key:
    file: ./secrets/gemini_api_key.txt
  huggingface_token:
    file: ./secrets/huggingface_token.txt

volumes:
  postgres_data:
  redis_data:
