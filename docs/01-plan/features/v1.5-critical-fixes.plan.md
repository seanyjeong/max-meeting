# v1.5 Critical Fixes Plan

> 사용자 테스트 피드백 기반 긴급 수정 사항

## 📋 개요

| 항목 | 내용 |
|------|------|
| **버전** | v1.5.0 |
| **생성일** | 2026-01-30 |
| **우선순위** | Critical |
| **예상 범위** | Frontend + Backend |

---

## 🐛 이슈 분류

### 🔴 Critical (C) - 핵심 기능 장애

| ID | 이슈 | 현상 | 원인 추정 |
|----|------|------|----------|
| **C1** | 안건-대화 매칭 오류 | 안건 클릭 후 녹음해도 제대로 매칭 안됨 | 타임스탬프 저장 타이밍 문제 |
| **C2** | 하하위(3레벨) 안건 미구현 | 하위 안건 아래 또 하위 안건 표시 안됨 | 재귀 깊이 제한 또는 파싱 문제 |
| **C3** | 안건-토론 불일치 | 파싱된 안건과 토론의 안건이 일치하지 않음 | agenda_id 매핑 오류 |
| **C4** | PDF 안건 혼합 | PDF에서 안건이 섞여서 표시됨 | 정렬/그룹화 로직 오류 |

### 🟡 Important (I) - 중요 기능 누락

| ID | 이슈 | 현상 | 필요 기능 |
|----|------|------|----------|
| **I1** | 질문 생성 기능 없음 | 질문 수정/삭제만 있고 새 질문 추가 불가 | 질문 CRUD 완성 |
| **I2** | STT 프로그레스바 미작동 | 원형 프로그레스바 퍼센트 안 나옴 | 시간 기반 추정 구현 |
| **I3** | 하위 안건 UI 너무 작음 | 대화내용에서 하위 안건이 안 보임 | 박스 크기 확대 |
| **I4** | 임시 참석자 CRUD | 연락처에 없는 참석자 추가 필요 | 이름+지점만 입력 |

### 🟢 Enhancement (E) - 개선 사항

| ID | 이슈 | 현상 | 개선 방향 |
|----|------|------|----------|
| **E1** | 가로모드 강제 | 세로모드로 작동 중 | 가로모드 lock 구현 |
| **E2** | 토큰 만료 UX | 갑자기 토큰 없어짐 표시 없음 | 만료 전 경고 또는 자동 갱신 |

---

## 🔍 상세 분석

### C1: 안건-대화 매칭 오류 (Critical) ✅ 분석 완료

**사용자 질문**: "버튼 클릭 후 아젠다 이동 후 몇 초 기다려야 하는건지? 버튼 클릭 후 바로 되는건지?"

**분석 결과 (정상 동작)**:
```
1. 녹음 중 안건 클릭 → 즉시 타임스탬프 저장 (기다릴 필요 없음)
2. AgendaNotePanel.svelte:124-126에서 isRecording일 때만 onAgendaChange 호출
3. openSegment()가 즉시 API 호출하여 time_segments 저장
```

**발견된 문제**:
- 로그에서 "no timestamp" 안건 존재 → 녹음 중 해당 안건 클릭 안 함
- 사용자가 녹음 전에 안건 선택 → 타임스탬프 없음
- **개선 필요**: 녹음 시작 시 현재 선택된 안건에 자동으로 타임스탬프 저장 (이미 구현됨 line:162-165)

**실제 문제 발견** (DB 분석 결과):
```
STT 세그먼트 "1억 원 장학금" (25.27~37.86초)
→ 세그먼트 시작(25.27초)이 안건 "상품 메뉴얼" (18~27초) 범위에 포함
→ 잘못된 안건에 매핑됨!
```

**근본 원인**:
- 현재 로직: 세그먼트 **시작 시간**으로만 안건 판단
- 문제: 사용자가 안건 클릭 직전에 말하면, 이전 안건에 매핑됨

**해결 방안 (우선순위)**:
1. **세그먼트 중간 시간** 기준: `(start + end) / 2` 로 매핑
2. **겹침 비율** 기준: 세그먼트가 가장 많이 겹치는 안건에 매핑
3. **UX 개선**: 안건 클릭 → 말하기 순서 안내

### C2: 하하위(3레벨) 안건 ✅ 분석 완료

**DB 확인 결과**:
```sql
-- level 2 안건들 (ID 29, 30, 31, 32) 타임스탬프 없음
-- 이유: 프론트엔드에 표시되지 않아 클릭 불가
```

**문제 원인 (2곳)**:

1. **백엔드** `backend/app/services/meeting.py:137`
   ```python
   .selectinload(Agenda.children)  # 1단계만 로드, 재귀 아님
   ```
   → children의 children 미로드

2. **프론트엔드** `AgendaNotePanel.svelte:224`
   ```svelte
   {#each agenda.children as child}  <!-- children만, 재귀 아님 -->
   ```
   → 하하위 렌더링 없음

**수정 포인트**:
1. `backend/app/services/meeting.py` - 재귀적 children 로드 또는 별도 쿼리
2. `frontend/src/lib/components/recording/AgendaNotePanel.svelte` - 재귀 렌더링 컴포넌트

### C3/C4: 안건-토론 불일치 & PDF 혼합

**v1.4 수정 내용**:
- LLM 프롬프트에 `[ID:숫자]` 형식 추가
- `agenda_id` 우선, `agenda_idx` 폴백

**여전한 문제 원인**:
1. C2와 연관: 하하위 안건이 로드되지 않아 매핑 오류
2. PDF 생성 시 정렬 로직 문제 가능

**검증 필요**:
- 로그에서 "num_discussions": 14 → 모든 안건에 매핑되었는지 확인
- PDF 생성 로직 확인

### I5: STT 원형 프로그레스바 (추가)

**현재 상태**: v1.4에서 RecordingsList에 선형 프로그레스바 추가
**요청**: 원형 프로그레스바로 변경

### I6: 토큰 만료 문제 (추가)

**증상**: "갑자기 토큰 없어짐"
**가능 원인**:
- JWT 토큰 60분 만료
- 새로고침 토큰 미구현
**개선**: 만료 전 경고 또는 자동 갱신

---

## 📝 구현 순서

### Phase 1: Critical 수정 (핵심 버그)
1. [x] C1 분석 완료: 세그먼트-안건 매핑 알고리즘 개선 필요
2. [ ] **C1 수정**: `backend/workers/tasks/llm.py` - 세그먼트 중간 시간 기준 매핑
3. [x] C2 분석 완료: 백엔드 + 프론트엔드 모두 수정 필요
4. [ ] **C2 수정 (백엔드)**: 재귀적 children 로드
5. [ ] **C2 수정 (프론트엔드)**: 재귀 렌더링 컴포넌트
6. [ ] C3/C4: C1, C2 수정 후 자연 해결 예상

### Phase 2: Important 구현
1. [ ] I1: 질문 생성 버튼/모달 추가
2. [ ] I2: STT 원형 프로그레스바
3. [ ] I3: 하위 안건 박스 크기 확대 (대화내용 뷰)
4. [ ] I4: 임시 참석자 CRUD (이름+지점)

### Phase 3: Enhancement
1. [ ] E1: 가로모드 강제 (CSS/JS)
2. [ ] E2: 토큰 만료 처리 (자동 갱신 또는 경고)

---

## 🎯 성공 기준

| 항목 | 기준 |
|------|------|
| 안건-대화 매칭 | 안건 클릭 직후 녹음 시작해도 정확히 매핑 |
| 3레벨 안건 | 파싱 → 표시 → PDF 모두 정상 |
| 질문 CRUD | 생성/수정/삭제 모두 작동 |
| 프로그레스바 | STT/LLM 모두 진행률 표시 |

---

## 📎 관련 파일

### Backend
- `backend/app/services/llm.py` - 안건 파싱 로직
- `backend/workers/tasks/stt.py` - STT 처리 및 매핑
- `backend/workers/tasks/llm.py` - 회의록 생성

### Frontend
- `frontend/src/routes/meetings/[id]/record/+page.svelte` - 녹음 페이지
- `frontend/src/routes/meetings/[id]/results/+page.svelte` - 결과 페이지
- `frontend/src/lib/components/agenda/*.svelte` - 안건 컴포넌트
- `frontend/src/lib/components/results/*.svelte` - 결과 컴포넌트
