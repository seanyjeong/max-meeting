import"../chunks/CWj6FrbW.js";import{p as Ce,o as Ne,aF as Me,e as ge,a as l,b as Ae,s as o,g as e,t as ce,h as fe,f as M,q as W,c as x,l as N,d as y,n as Z,r as $,y as ue,z as Ye,E as he,u as Re,v as Ze,C as Je,w as de,$ as Ke,Z as et}from"../chunks/dEE0t6TH.js";import{i as ve}from"../chunks/C3dn6ghA.js";import{h as tt}from"../chunks/C-8mY6PU.js";import{s as at,a as rt}from"../chunks/VgTo3XoD.js";import{b as nt}from"../chunks/CQIO9Ee8.js";import{s as ke,a as H}from"../chunks/IoHDDGUh.js";import{p as ot}from"../chunks/cT6OB_cF.js";import{b as st,g as Le}from"../chunks/DzGFvkG0.js";import{c as it}from"../chunks/BEFWedIY.js";import{M as pe,B as J,c as Pe,i as Te,d as Ue,f as lt,e as C,g as dt,j as ct,v as oe,C as ut,k as vt,N as gt,l as ft}from"../chunks/DKX1Bax4.js";import{a as se}from"../chunks/nFeSIjG2.js";import{t as pt}from"../chunks/DADtNw1e.js";import{B as mt}from"../chunks/1ZOD2yLP.js";import{L as ht}from"../chunks/6EBku0UH.js";import"../chunks/BNjbk8Ua.js";import{p as _t}from"../chunks/DtOJ18OM.js";var yt=M('<div class="flex justify-end gap-3"><!> <!></div>'),$t=M('<div class="text-gray-600"><p class="mb-4">녹음이 진행 중입니다. 페이지를 떠나면 녹음이 중단됩니다.</p> <p class="text-sm text-gray-500">저장되지 않은 녹음 데이터는 복구할 수 있습니다.</p></div>'),wt=M('<div class="flex justify-end gap-3"><!> <!></div>'),bt=M('<div class="text-gray-600"><p class="mb-4"> </p> <p>정말로 녹음을 종료하시겠습니까?</p></div>'),xt=M("<!> <!>",1);function St(c,m){Ce(m,!0);const v=()=>H(Te,"$isRecording",j),w=()=>H(Ue,"$isPaused",j),ie=()=>H(Pe,"$recordingTime",j),[j,re]=ke();let i=_t(m,"minimumDuration",3,300),d=N(!1),h=N(!1),r=null;function a(_){if(v()||w())return _.preventDefault(),_.returnValue="녹음이 진행 중입니다. 페이지를 나가시겠습니까?",_.returnValue}Ne(()=>{window.addEventListener("beforeunload",a)}),Me(()=>{window.removeEventListener("beforeunload",a)}),st(({cancel:_,to:g})=>{(v()||w())&&(_(),r=()=>{g!=null&&g.url&&(window.location.href=g.url.href)},o(d,!0))});function u(){var _;o(d,!1),(_=m.onConfirmLeave)==null||_.call(m),r&&(r(),r=null)}function q(){o(d,!1),r=null}function f(){return ie()<i()?(o(h,!0),!1):!0}function G(){var _;o(h,!1),(_=m.onConfirmStop)==null||_.call(m)}function T(){o(h,!1)}var Q={checkMinimumDuration:f},D=xt(),b=ge(D);pe(b,{title:"녹음 진행 중",size:"sm",get open(){return e(d)},set open(g){o(d,g,!0)},footer:g=>{var S=yt(),A=y(S);J(A,{variant:"secondary",onclick:q,children:(U,ee)=>{Z();var E=W("계속 녹음");l(U,E)},$$slots:{default:!0}});var B=x(A,2);J(B,{variant:"danger",onclick:u,children:(U,ee)=>{Z();var E=W("페이지 나가기");l(U,E)},$$slots:{default:!0}}),$(S),l(g,S)},children:(g,S)=>{var A=$t();l(g,A)},$$slots:{footer:!0,default:!0}});var X=x(b,2);pe(X,{title:"녹음 종료 확인",size:"sm",get open(){return e(h)},set open(g){o(h,g,!0)},footer:g=>{var S=wt(),A=y(S);J(A,{variant:"secondary",onclick:T,children:(U,ee)=>{Z();var E=W("계속 녹음");l(U,E)},$$slots:{default:!0}});var B=x(A,2);J(B,{variant:"danger",onclick:G,children:(U,ee)=>{Z();var E=W("녹음 종료");l(U,E)},$$slots:{default:!0}}),$(S),l(g,S)},children:(g,S)=>{var A=bt(),B=y(A),U=y(B);$(B),Z(2),$(A),ce(ee=>fe(U,`녹음 시간이 ${ee??""}분 미만입니다.`),[()=>Math.floor(i()/60)]),l(g,A)},$$slots:{footer:!0,default:!0}}),l(c,D);var K=Ae(Q);return re(),K}const Rt=30*1e3;function Lt(){const{subscribe:c,set:m,update:v}=Ye({notes:new Map,dirtyNotes:new Set,isLoading:!1,isSaving:!1,error:null,lastSavedAt:null,meetingId:null});let w=null;const ie=()=>{w&&clearInterval(w),w=setInterval(async()=>{await re()},Rt)},j=()=>{w&&(clearInterval(w),w=null)},re=async()=>{const i=he({subscribe:c});if(i.dirtyNotes.size===0||i.isSaving||!i.meetingId)return;v(r=>({...r,isSaving:!0,error:null}));const h=Array.from(i.dirtyNotes).map(async r=>{var u,q;const a=i.notes.get(r);if(a)try{if(console.log("[notes] 노트 저장 시작:",{agendaId:r,noteId:a.id,contentLength:(u=a.content)==null?void 0:u.length,meetingId:i.meetingId}),a.id)await se.patch(`/notes/${a.id}`,{content:a.content}),console.log("[notes] 노트 업데이트 완료:",a.id);else{console.log("[notes] 새 노트 생성 요청:",{agenda_id:a.agendaId,content_length:(q=a.content)==null?void 0:q.length});const f=await se.post(`/meetings/${i.meetingId}/notes`,{agenda_id:a.agendaId,content:a.content});console.log("[notes] 새 노트 생성 완료:",f==null?void 0:f.id),v(G=>{const T=new Map(G.notes),Q=T.get(r);return Q&&(f!=null&&f.id)&&T.set(r,{...Q,id:f.id,createdAt:new Date(f.created_at),updatedAt:new Date(f.updated_at)}),{...G,notes:T}})}}catch(f){throw console.error(`Failed to save note for agenda ${r}:`,f),f}});try{await Promise.all(h),v(r=>({...r,dirtyNotes:new Set,isSaving:!1,lastSavedAt:new Date,error:null}))}catch(r){const a=r instanceof Error?r.message:"Failed to save notes";v(u=>({...u,isSaving:!1,error:a}))}};return{subscribe:c,async loadNotes(i){v(d=>({...d,isLoading:!0,error:null}));try{const d=await se.get(`/meetings/${i}/notes`),h=new Map;d.data.forEach(r=>{h.set(r.agenda_id,{id:r.id,agendaId:r.agenda_id,content:r.content,createdAt:r.created_at?new Date(r.created_at):void 0,updatedAt:r.updated_at?new Date(r.updated_at):void 0})}),v(r=>({...r,notes:h,dirtyNotes:new Set,isLoading:!1,error:null,meetingId:i})),ie()}catch(d){const h=d instanceof Error?d.message:"Failed to load notes";v(r=>({...r,isLoading:!1,error:h}))}},async saveNote(i,d){v(h=>{const r=new Map(h.notes),a=r.get(i);r.set(i,{...a,agendaId:i,content:d,id:a==null?void 0:a.id});const u=new Set(h.dirtyNotes);return u.add(i),{...h,notes:r,dirtyNotes:u}})},getNote(i){return he({subscribe:c}).notes.get(i)},async forceSave(){await re()},cleanup(){j(),m({notes:new Map,dirtyNotes:new Set,isLoading:!1,isSaving:!1,error:null,lastSavedAt:null,meetingId:null})}}}const z=Lt();ue(z,c=>c.isLoading);ue(z,c=>c.isSaving);ue(z,c=>c.error);ue(z,c=>c.lastSavedAt);ue(z,c=>c.dirtyNotes.size>0);async function Ct(){var c;try{const m=await((c=navigator.getBattery)==null?void 0:c.call(navigator));return m?{level:Math.round(m.level*100),charging:m.charging}:null}catch{return null}}async function Nt(c){var m;try{const v=await((m=navigator.getBattery)==null?void 0:m.call(navigator));if(!v)return()=>{};const w=()=>{c({level:Math.round(v.level*100),charging:v.charging})};return v.addEventListener("levelchange",w),v.addEventListener("chargingchange",w),()=>{v.removeEventListener("levelchange",w),v.removeEventListener("chargingchange",w)}}catch{return()=>{}}}var Mt=M('<div class="flex justify-center py-12 pt-20"><!></div>'),At=M('<div role="alert"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"></path></svg> <span class="text-sm font-medium"> </span></div>'),kt=M('<!> <div class="pt-[120px]"><div class="px-4 py-3 border-b bg-white"><div class="flex items-center justify-between"><!> <!></div></div> <div class="flex h-[calc(100vh-172px)]"><div class="w-1/4 min-w-64 max-w-80 border-r"><!></div> <div class="flex-1"><!></div></div></div>',1),Pt=M('<div class="flex justify-end gap-3"><!> <!></div>'),Tt=M('<div class="text-gray-600"><p class="mb-4">이전에 저장되지 않은 녹음 데이터가 있습니다.</p> <p>복구하시겠습니까?</p></div>'),Ut=M('<div class="flex justify-end gap-3"><!> <!></div>'),Dt=M('<audio controls class="w-full"><track kind="captions"/> Your browser does not support the audio element.</audio>'),zt=M('<div class="space-y-4"><p class="text-gray-600">녹음이 완료되었습니다. 10초간 미리 들어보세요.</p> <!> <div class="text-sm text-gray-500"> </div></div>'),jt=M("<!> <!> <!> <!>",1);function ta(c,m){Ce(m,!0);const v=()=>H(ot,"$page",d),w=()=>H(Te,"$isRecording",d),ie=()=>H(Ue,"$isPaused",d),j=()=>H(Pe,"$recordingTime",d),re=()=>H(oe,"$visualizationStore",d),i=()=>H(ft,"$batteryWarning",d),[d,h]=ke();let r=de(()=>parseInt(v().params.id||"",10)),a=N(null),u=N(0),q=N("text"),f=N(Re(new Map)),G=N(Re(new Map)),T=N(!1),Q=N(!1),D=N(!1),b=N(null),X=N(null),K=N(!1),_=N(0),g,S=null;const A=de(()=>{var t;return[{label:"Home",href:"/"},{label:"회의",href:"/meetings"},{label:((t=e(a))==null?void 0:t.title)||"회의",href:`/meetings/${e(r)}`},{label:"녹음",href:`/meetings/${e(r)}/record`}]});Ne(async()=>{try{const n=await se.get(`/meetings/${e(r)}`);o(a,n,!0),it.set(n);const s=e(a).agendas.findIndex(R=>R.status!=="completed");o(u,s>=0?s:0,!0),await z.loadNotes(e(r));const p=he(z);o(f,new Map([...p.notes].map(([R,L])=>[R,L.content])),!0)}catch{Le("/meetings");return}o(Q,await ct(e(r)),!0),e(Q)&&o(T,!0);const t=await Ct();t&&C.updateBatteryStatus(t.level,t.charging),S=await Nt(n=>{C.updateBatteryStatus(n.level,n.charging)})}),Me(async()=>{S==null||S(),C.reset(),oe.stop(),e(b)&&URL.revokeObjectURL(e(b)),await z.forceSave(),z.cleanup()});function B(t,n){if(!t||typeof t!="number"||isNaN(t)){console.warn("[record] handleNoteChange: 유효하지 않은 agendaId:",t);return}console.log("[record] handleNoteChange: agendaId:",t,"내용 길이:",n.length),z.saveNote(t,n),o(f,new Map(e(f).set(t,n)),!0)}function U(t){if(e(a)&&e(a).agendas[e(u)]){const n=e(a).agendas[e(u)].id;o(G,new Map(e(G).set(n,t)),!0)}}function ee(t){o(q,t,!0)}async function E(){if(await C.start(e(r))){const n=C.getMediaRecorder();if(n&&oe.start(n),e(a)&&e(a).agendas.length>0){const s=e(a).agendas[e(u)];await _e(s.id,0)}}}function De(){C.pause()}function ze(){C.resume()}async function je(){if(g&&!g.checkMinimumDuration())return;oe.stop();const t=await C.stop();t&&(o(X,t,!0),o(b,URL.createObjectURL(t),!0),o(D,!0))}function Be(){Ee()}async function Ee(){oe.stop();const t=await C.stop();t&&(o(X,t,!0),o(b,URL.createObjectURL(t),!0),o(D,!0))}async function Ie(){if(e(X)){o(K,!0),o(_,0);try{(await C.uploadRecording(e(r),e(X),n=>{o(_,n,!0)})).success?(await C.clearSavedChunks(e(r)),o(D,!1),e(b)&&(URL.revokeObjectURL(e(b)),o(b,null)),Le(`/meetings/${e(r)}/results`)):(console.error("Upload failed"),pt.error("업로드에 실패했습니다. 다시 시도해주세요."))}finally{o(K,!1)}}}function Oe(){o(D,!1),e(b)&&(URL.revokeObjectURL(e(b)),o(b,null)),o(X,null),C.reset()}async function Fe(){const t=await dt(e(r));t&&(o(X,t,!0),o(b,URL.createObjectURL(t),!0),o(T,!1),o(D,!0))}async function Ve(){await C.clearSavedChunks(e(r)),o(T,!1),o(Q,!1)}async function He(t,n){await _e(t,n),e(a)&&e(u)<e(a).agendas.length-1&&et(u)}async function _e(t,n){try{await se.patch(`/agendas/${t}`,{started_at_seconds:n,status:"in_progress"}),e(a)&&o(a,{...e(a),agendas:e(a).agendas.map(s=>s.id===t?{...s,started_at_seconds:n,status:"in_progress"}:s)},!0)}catch(s){console.error("Failed to update agenda timestamp:",s)}}async function We(t,n){try{await se.patch(`/questions/${t}`,{answered:n}),e(a)&&o(a,{...e(a),agendas:e(a).agendas.map(s=>({...s,questions:s.questions.map(p=>p.id===t?{...p,answered:n}:p)}))},!0)}catch(s){console.error("Failed to toggle question:",s)}}function qe(){C.reset(),oe.stop()}var ye=jt();tt("1kyotz9",t=>{Ze(()=>{var n;Ke.title=`녹음 - ${(((n=e(a))==null?void 0:n.title)||"회의")??""} - MAX Meeting`})});var $e=ge(ye);nt(St($e,{onConfirmLeave:qe,onConfirmStop:Be}),t=>g=t,()=>g);var we=x($e,2);{var Ge=t=>{var n=Mt(),s=y(n);ht(s,{size:"lg"}),$(n),l(t,n)},Qe=t=>{var n=kt(),s=ge(n);{let F=de(()=>{var V;return((V=e(a).agendas[e(u)])==null?void 0:V.title)||""});ut(s,{get isRecording(){return w()},get isPaused(){return ie()},get recordingTime(){return j()},get currentAgenda(){return e(F)},get visualizationData(){return re().analyserData},onStart:E,onStop:je,onPause:De,onResume:ze})}var p=x(s,2),R=y(p),L=y(R),I=y(L);mt(I,{get items(){return e(A)}});var k=x(I,2);{var O=F=>{var V=At(),P=x(y(V),2),ne=y(P,!0);$(P),$(V),ce(()=>{rt(V,1,`flex items-center gap-2 px-3 py-1 rounded-full ${i()==="critical"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`),fe(ne,i()==="critical"?"배터리 부족!":"배터리 낮음")}),l(F,V)};ve(k,F=>{i()&&F(O)})}$(L),$(R);var te=x(R,2),le=y(te),Y=y(le);vt(Y,{get agendas(){return e(a).agendas},get notes(){return e(f)},get recordingTime(){return j()},onNextAgenda:He,onQuestionToggle:We,onNoteChange:B,get currentAgendaIndex(){return e(u)},set currentAgendaIndex(F){o(u,F,!0)}}),$(le);var ae=x(le,2),me=y(ae);{let F=de(()=>{var P;return e(f).get((P=e(a).agendas[e(u)])==null?void 0:P.id)||""}),V=de(()=>{var P;return e(G).get((P=e(a).agendas[e(u)])==null?void 0:P.id)});gt(me,{get textContent(){return e(F)},get sketchSnapshot(){return e(V)},onTabChange:ee,onTextChange:P=>{var xe,Se;const ne=(Se=(xe=e(a))==null?void 0:xe.agendas)==null?void 0:Se[e(u)];ne!=null&&ne.id&&B(ne.id,P)},onSketchChange:U,get activeTab(){return e(q)},set activeTab(P){o(q,P,!0)}})}$(ae),$(te),$(p),l(t,n)};ve(we,t=>{e(a)?t(Qe,!1):t(Ge)})}var be=x(we,2);pe(be,{title:"미저장 녹음 발견",size:"sm",get open(){return e(T)},set open(n){o(T,n,!0)},footer:n=>{var s=Pt(),p=y(s);J(p,{variant:"secondary",onclick:Ve,children:(L,I)=>{Z();var k=W("삭제");l(L,k)},$$slots:{default:!0}});var R=x(p,2);J(R,{variant:"primary",onclick:Fe,children:(L,I)=>{Z();var k=W("복구");l(L,k)},$$slots:{default:!0}}),$(s),l(n,s)},children:(n,s)=>{var p=Tt();l(n,p)},$$slots:{footer:!0,default:!0}});var Xe=x(be,2);pe(Xe,{title:"녹음 확인",size:"md",get open(){return e(D)},set open(n){o(D,n,!0)},footer:n=>{var s=Ut(),p=y(s);J(p,{variant:"secondary",onclick:Oe,get disabled(){return e(K)},children:(L,I)=>{Z();var k=W("다시 녹음");l(L,k)},$$slots:{default:!0}});var R=x(p,2);J(R,{variant:"primary",onclick:Ie,get disabled(){return e(K)},children:(L,I)=>{var k=Je(),O=ge(k);{var te=Y=>{var ae=W();ce(me=>fe(ae,`업로드 중... ${me??""}%`),[()=>Math.round(e(_))]),l(Y,ae)},le=Y=>{var ae=W("업로드");l(Y,ae)};ve(O,Y=>{e(K)?Y(te):Y(le,!1)})}l(L,k)},$$slots:{default:!0}}),$(s),l(n,s)},children:(n,s)=>{var p=zt(),R=x(y(p),2);{var L=O=>{var te=Dt();ce(()=>at(te,"src",e(b))),l(O,te)};ve(R,O=>{e(b)&&O(L)})}var I=x(R,2),k=y(I);$(I),$(p),ce(O=>fe(k,`녹음 시간: ${O??""}`),[()=>lt(j())]),l(n,p)},$$slots:{footer:!0,default:!0}}),l(c,ye),Ae(),h()}export{ta as component};
